name: Lunaris CI/CD

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ==================== LINTING ====================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache
        uses: Swatinem/rust-cache@v2
      
      - name: Format check
        run: cargo fmt --all -- --check
      
      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ==================== TESTING ====================
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
      
      - name: Cache
        uses: Swatinem/rust-cache@v2
      
      - name: Run tests
        run: cargo test --all-features --verbose
      
      - name: Run doc tests
        run: cargo test --doc

  # ==================== BUILD ====================
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: [lint, test]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: lunaris-linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: lunaris-windows-x64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: lunaris-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: lunaris-macos-arm64
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Cache
        uses: Swatinem/rust-cache@v2
      
      - name: Build Release
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Package (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/lunaris-editor dist/ || true
          cp target/${{ matrix.target }}/release/lunaris-runtime dist/ || true
          cp -r docs dist/
          cp README.md LICENSE dist/
          tar -czvf ${{ matrix.artifact }}.tar.gz -C dist .
      
      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir dist
          copy target\${{ matrix.target }}\release\*.exe dist\ 2>nul || echo "No exe files"
          copy README.md dist\
          copy LICENSE dist\ 2>nul || echo "No license"
          Compress-Archive -Path dist\* -DestinationPath ${{ matrix.artifact }}.zip
        shell: pwsh
      
      - name: Package (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/lunaris-editor dist/ 2>/dev/null || true
          cp target/${{ matrix.target }}/release/lunaris-runtime dist/ 2>/dev/null || true
          cp -r docs dist/
          cp README.md dist/
          tar -czvf ${{ matrix.artifact }}.tar.gz -C dist .
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            *.tar.gz
            *.zip

  # ==================== DOCS ====================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
      
      - name: Build docs
        run: cargo doc --no-deps --all-features
      
      - name: Upload docs
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: target/doc

  # ==================== RELEASE ====================
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: List artifacts
        run: find artifacts -type f
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Lunaris ${{ github.ref_name }}
          body: |
            ## ðŸŒ™ Lunaris Engine ${{ github.ref_name }}
            
            ### Downloads
            
            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Windows | x64 | `lunaris-windows-x64.zip` |
            | Linux | x64 | `lunaris-linux-x64.tar.gz` |
            | macOS | x64 | `lunaris-macos-x64.tar.gz` |
            | macOS | ARM64 | `lunaris-macos-arm64.tar.gz` |
            
            ### Installation
            
            #### Windows
            ```powershell
            # Download and extract
            Invoke-WebRequest -Uri "https://github.com/gabrielima7/Lunaris/releases/download/${{ github.ref_name }}/lunaris-windows-x64.zip" -OutFile "lunaris.zip"
            Expand-Archive lunaris.zip -DestinationPath "C:\Lunaris"
            ```
            
            #### Linux
            ```bash
            curl -LO https://github.com/gabrielima7/Lunaris/releases/download/${{ github.ref_name }}/lunaris-linux-x64.tar.gz
            tar -xzf lunaris-linux-x64.tar.gz -C /opt/lunaris
            ```
            
            #### macOS
            ```bash
            curl -LO https://github.com/gabrielima7/Lunaris/releases/download/${{ github.ref_name }}/lunaris-macos-x64.tar.gz
            tar -xzf lunaris-macos-x64.tar.gz -C /Applications/Lunaris
            ```
            
            ### Changelog
            
            See [CHANGELOG.md](https://github.com/gabrielima7/Lunaris/blob/main/CHANGELOG.md)
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== SECURITY ====================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cargo-audit
        run: cargo install cargo-audit
      
      - name: Security audit
        run: cargo audit || true

  # ==================== COVERAGE ====================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
      
      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin
      
      - name: Generate coverage
        run: cargo tarpaulin --out Xml --all-features
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: cobertura.xml
